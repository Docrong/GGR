<?xml version="1.0" encoding="UTF-8"?>
<kpi>
     <cnname>工单号, 地区名称,工单信息, 派单时间, 处理环节</cnname>
     <enname>sheetid,id,areaname,title,sendtime, dealname</enname>
     <sql> 
 select max(sheetid)sheetid,max(id)id,getareaname(max(areaid))areaid,max(title)title,max(sendtime)sendtime,max(status)status
from (
select m1.id,m1.sheetid,m1.sendtime,m1.title,m1.mainalarmnum,decode(m1.status,'0','运行中','1' ,'已归档') status,
m1.todeptid areaid,
l3.operatetime-0 t2accepttime,
l4.operatetime-0 t2completetime,
l2.nodecompletelimit-0 t2completelimit,
l4.completeflag,
l4.operateuserid t2userid,
getusername(l4.operateuserid) t2username,
l4.operatedeptid
From commonfault_main m1,commonfault_link l1
,(select  m.id,max(l.operatetime)operatetime,operatetype,activetemplateid from commonfault_main m,commonfault_link l 
          where m.id = l.mainid and m.sendtime &gt;to_date('{2}','yyyy-mm-dd hh24:mi:ss') and m.sendtime&lt;to_date('{1}','yyyy-mm-dd hh24:mi:ss') and l.operatetype in (1,61,46,7)
                  group by m.id,operatetype,activetemplateid 
    ) t0 
,commonfault_link l2
,commonfault_link l3 
,commonfault_link l4 
 where m1.sendtime &gt;to_date('{2}','yyyy-mm-dd hh24:mi:ss') and m1.sendtime&lt;to_date('{1}','yyyy-mm-dd hh24:mi:ss')
 and m1.id =l1.mainid and l1.mainid = t0.id and l1.operatetime = t0.operatetime and l1.operatetype = t0.operatetype and m1.status in (0,1) and m1.deleted=0
 and l2.operatetype(+) = '1' and l2.activetemplateid(+)='FirstExcuteHumTask'  and l1.id= l2.id(+)
 and l3.operatetype(+) = '61' and l3.activetemplateid(+)='SecondExcuteHumTask'  and l1.id= l3.id(+)
 and l4.operatetype(+) = '46' and l4.activetemplateid(+)='SecondExcuteHumTask' and l1.id= l4.id(+)
 and m1.todeptid ='{0}'
)group by id having decode(max(t2completetime),'',ifbigtime(sysdate,max(t2completelimit)),ifbigtime(max(t2completetime),max(t2completelimit)),1,'0') &gt;0
</sql>
   <a>sheetid,N,N,N</a>
   <groupby> todeptid</groupby>

</kpi>
